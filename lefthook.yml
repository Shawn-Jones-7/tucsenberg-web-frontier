# Git Hooksç®¡ç†é…ç½®
# è‡ªåŠ¨åŒ–è´¨é‡é—¨ç¦ç³»ç»Ÿ - ç¡®ä¿ä»£ç è´¨é‡å’Œå®‰å…¨æ€§
# è´¨é‡é˜ˆå€¼ç»Ÿä¸€ç”± scripts/quality-gate.js ç®¡ç†
pre-commit:
  parallel: true
  commands:
    # ä»£ç æ ¼å¼æ£€æŸ¥ (Prettier)
    format-check:
      run: |
        FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|md|mdx|yml|yaml|css|scss|html)$' || true)
        if [ -z "$FILES" ]; then echo "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡ (æ— å¯æ ¼å¼åŒ–å˜æ›´)"; exit 0; fi
        pnpm exec prettier --check $FILES
      fail_text: 'ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥ - è¯·è¿è¡Œ pnpm format:write ä¿®å¤æ ¼å¼é—®é¢˜'
      stage_fixed: true

    # TypeScriptç±»å‹æ£€æŸ¥
    type-check:
      run: pnpm type-check
      fail_text: 'TypeScriptç±»å‹æ£€æŸ¥å¤±è´¥ - è¯·ä¿®å¤ç±»å‹é”™è¯¯åé‡æ–°æäº¤'
      stage_fixed: true

    # ä»£ç è´¨é‡æ£€æŸ¥ (ESLint) - ä½¿ç”¨å¢é‡æ£€æŸ¥é¿å…å†å²é—®é¢˜é˜»å¡
    quality-check:
      run: pnpm quality:quick:staged
      fail_text: 'ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ - å‘ç°æ–°çš„è´¨é‡é—®é¢˜ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤'
      stage_fixed: true

    # æ¶æ„å®ˆå« - ä»…æ£€æŸ¥å·²æš‚å­˜çš„ JS/TS å˜æ›´ï¼ˆæ’é™¤æµ‹è¯•æ–‡ä»¶å’Œè„šæœ¬ç›®å½•ï¼‰
    architecture-guard:
      run: |
        FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep -v '^tests/' | grep -v '__tests__' | grep -v '^scripts/' || true)
        if [ -z "$FILES" ]; then echo "âœ… æ¶æ„å®ˆå«æ£€æŸ¥é€šè¿‡ (æ—  JS/TS å˜æ›´)"; exit 0; fi
        for f in $FILES; do
          if git diff --cached -- "$f" | grep -qE '^\+.*export \* from'; then
            echo "âŒ å‘ç°æ–°å¢export *é‡æ–°å¯¼å‡º: $f"; echo "ğŸš« æ¶æ„é‡æ„æœŸé—´ç¦æ­¢æ–°å¢ export * é‡æ–°å¯¼å‡º";
            echo "è¯·ä½¿ç”¨å‘½åå¯¼å‡ºï¼šexport { specificExport } from './module'"; exit 1; fi
        done
        for f in $FILES; do
          # ä¾‹å¤–ï¼šsrc/config/security.ts è¢« next.config.ts å¼•ç”¨ï¼Œå¿…é¡»ä½¿ç”¨ç›¸å¯¹è·¯å¾„
          if [ "$f" = "src/config/security.ts" ]; then continue; fi
          if git diff --cached -- "$f" | grep -qE "^\+.*from ['\"']\./|^\+.*from ['\"']\.\./"; then
            echo "âŒ å‘ç°æ–°å¢ç›¸å¯¹è·¯å¾„å¯¼å…¥: $f"; echo "ğŸš« è¯·ä½¿ç”¨ @/ è·¯å¾„åˆ«åæ›¿ä»£ç›¸å¯¹è·¯å¾„å¯¼å…¥";
            echo "ä¾‹å¦‚ï¼šimport { something } from '@/lib/module'"; exit 1; fi
        done
        echo "âœ… æ¶æ„å®ˆå«æ£€æŸ¥é€šè¿‡"
      fail_text: 'æ¶æ„å®ˆå«æ£€æŸ¥å¤±è´¥ - å‘ç°è¿åæ¶æ„é‡æ„è§„åˆ™çš„ä»£ç å˜æ›´'
      stage_fixed: false

    # åˆ«åä¸€è‡´æ€§æ£€æŸ¥
    config-check:
      run: pnpm config:check
      fail_text: 'åˆ«åä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ - è¯·ä¿®å¤ tsconfig/next.config/ESLint é…ç½®ä¸€è‡´æ€§'
      stage_fixed: false

    # å¤šè¯­è¨€åŒæ­¥æ£€æŸ¥
    i18n-sync:
      run: |
        if git diff --cached --name-only | grep -E '^(messages/|content/|i18n\.(json|ts)$|src/.+i18n|translation\.config\.js)' >/dev/null; then
          pnpm i18n:full
        else
          echo "è·³è¿‡ i18n åŒæ­¥æ£€æŸ¥ï¼ˆæ— ç›¸å…³å˜æ›´ï¼‰"; exit 0;
        fi
      fail_text: 'å¤šè¯­è¨€åŒæ­¥æ£€æŸ¥å¤±è´¥ - è¯·åŒæ­¥ messages ä¸å†…å®¹æ–‡ä»¶çš„ä¸­è‹±ç‰ˆæœ¬'
      stage_fixed: false

    # ç›¸å…³æµ‹è¯•æ£€æŸ¥ - ç¡®ä¿ç»„ä»¶/åº“å˜æ›´åæµ‹è¯•åŒæ­¥æ›´æ–°
    # ä½¿ç”¨ Vitest 4 çš„ `vitest related` å­å‘½ä»¤
    test-related:
      run: |
        FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^src/.+\.(ts|tsx)$' | grep -v '\.test\.' | grep -v '\.spec\.' | grep -v '__tests__' || true)
        if [ -z "$FILES" ]; then
          echo "âœ… ç›¸å…³æµ‹è¯•æ£€æŸ¥é€šè¿‡ (æ— æºç å˜æ›´)"; exit 0;
        fi
        echo "ğŸ§ª è¿è¡Œç›¸å…³æµ‹è¯•..."
        pnpm vitest related $FILES --run --passWithNoTests --reporter=dot 2>/dev/null || {
          echo ""; echo "âŒ ç›¸å…³æµ‹è¯•å¤±è´¥ - å¯èƒ½åŸå› :";
          echo "  1. ç»„ä»¶ DOM ç»“æ„å˜æ›´ï¼Œä½†æµ‹è¯•ä¸­çš„ getByRole/getByText æœªåŒæ­¥";
          echo "  2. æ¥å£å±æ€§å˜æ›´ï¼Œä½† Mock é…ç½®æœªæ›´æ–°";
          echo "  3. å‡½æ•°ç­¾åå˜æ›´ï¼Œä½†æµ‹è¯•æ–­è¨€æœªæ›´æ–°";
          echo ""; echo "ğŸ’¡ è¯·æ£€æŸ¥å¹¶åŒæ­¥æ›´æ–°å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶";
          exit 1;
        }
      fail_text: 'ç›¸å…³æµ‹è¯•å¤±è´¥ - è¯·ç¡®ä¿æºç å˜æ›´åæµ‹è¯•åŒæ­¥æ›´æ–°ï¼ˆå‚è§ .claude/rules/testing.md Twin File Principleï¼‰'
      stage_fixed: false

commit-msg:
  commands:
    commitlint:
      run: pnpm commitlint --edit {1}
      fail_text:
        'æäº¤ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒ - è¯·ä½¿ç”¨çº¦å®šå¼æäº¤æ ¼å¼ï¼štype(scope): description'

pre-push:
  parallel: false  # ä¸²è¡Œæ‰§è¡Œï¼Œç¡®ä¿æ„å»ºå…ˆå®Œæˆ
  commands:
    # æ„å»ºæˆåŠŸéªŒè¯ï¼ˆA+ï¼šé»˜è®¤æ‰§è¡Œï¼›ç´§æ€¥åœºæ™¯å¯ç”¨ RUN_FAST_PUSH=1 è·³è¿‡ï¼‰
    build-check:
      run: |
        if [ -n "$RUN_FAST_PUSH" ]; then
          echo "â­ï¸  RUN_FAST_PUSH=1: è·³è¿‡æ„å»ºéªŒè¯ï¼ˆä»…ç”¨äºç´§æ€¥æ¨é€ï¼‰";
        else
          pnpm build:check
        fi
      fail_text: 'æ„å»ºéªŒè¯å¤±è´¥ - è¯·ä¿®å¤æ„å»ºé”™è¯¯åå†æ¨é€'

    # ç¿»è¯‘éªŒè¯ï¼ˆä¿æŒæ‰§è¡Œï¼Œé€Ÿåº¦å¿«ï¼‰
    translation-check:
      run: pnpm validate:translations
      fail_text: 'ç¿»è¯‘éªŒè¯å¤±è´¥ - è¯·ç¡®ä¿æ‰€æœ‰ç¿»è¯‘æ–‡ä»¶åŒæ­¥'

    # è´¨é‡é—¨ç¦ï¼ˆå•ä¸€æƒå¨æºï¼šscripts/quality-gate.jsï¼‰
    # - æœ¬åœ°: ä½¿ç”¨ --mode=fast è·³è¿‡è¦†ç›–ç‡å’Œæ€§èƒ½æµ‹è¯•ï¼ˆ<2åˆ†é’Ÿï¼‰
    # - CI: ä½¿ç”¨å®Œæ•´æ¨¡å¼ï¼ˆç”± CI é…ç½®æ§åˆ¶ï¼‰
    # - ç´§æ€¥æ¨é€: è®¾ç½® RUN_FAST_PUSH=1 å®Œå…¨è·³è¿‡
    quality-gate:
      run: |
        if [ -n "$RUN_FAST_PUSH" ]; then
          echo "â­ï¸  RUN_FAST_PUSH=1: è·³è¿‡è´¨é‡é—¨ç¦ï¼ˆä»…ç”¨äºç´§æ€¥æ¨é€ï¼ŒCI ä¼šå…œåº•ï¼‰";
        elif [ -n "$CI" ]; then
          echo "ğŸ¤– CI ç¯å¢ƒ: è¿è¡Œå®Œæ•´è´¨é‡é—¨ç¦";
          pnpm quality:gate
        else
          echo "ğŸ’» æœ¬åœ°ç¯å¢ƒ: è¿è¡Œå¿«é€Ÿè´¨é‡é—¨ç¦ï¼ˆè·³è¿‡è¦†ç›–ç‡å’Œæ€§èƒ½æµ‹è¯•ï¼‰";
          echo "   é˜ˆå€¼ç»Ÿä¸€ç”± scripts/quality-gate.js ç®¡ç†";
          pnpm quality:gate:fast
        fi
      fail_text: 'è´¨é‡é—¨ç¦å¤±è´¥ - é˜ˆå€¼ç”± scripts/quality-gate.js ç®¡ç†ï¼Œè¯·ä¿®å¤è´¨é‡é—®é¢˜åå†æ¨é€'

    # æ¶æ„æ£€æŸ¥ï¼ˆA+ï¼šå…¨é‡å·¡èˆª + å¾ªç¯ä¾èµ–ï¼›ä½¿ç”¨ err æŠ¥å‘Šå‡å°‘å™ªéŸ³ï¼›å¯ç”¨ RUN_FAST_PUSH=1 è·³è¿‡åº”æ€¥æ¨é€ï¼‰
    arch-check:
      run: |
        if [ -n "$RUN_FAST_PUSH" ]; then
          echo "â­ï¸  RUN_FAST_PUSH=1: è·³è¿‡æ¶æ„æ£€æŸ¥ï¼ˆä»…ç”¨äºç´§æ€¥æ¨é€ï¼ŒCI/åç»­æœ¬åœ°è¯·è¡¥è·‘ï¼‰";
        else
          pnpm exec dependency-cruiser src --config .dependency-cruiser.js -T err
          pnpm circular:check
        fi
      fail_text: 'æ¶æ„æ£€æŸ¥å¤±è´¥ - å‘ç°å¾ªç¯ä¾èµ–æˆ–æ¶æ„è¿è§„'

    # E2E å¸ƒå±€å›å½’æ£€æŸ¥ï¼ˆé»˜è®¤è·³è¿‡ï¼›è®¾ç½® RUN_E2E_LAYOUT=1 å¯ç”¨ï¼‰
    e2e-layout-check:
      run: |
        if [ -n "$RUN_E2E_LAYOUT" ]; then
          echo "ğŸ§­ RUN_E2E_LAYOUT=1: è¿è¡Œ header bbox å¸ƒå±€å›å½’ç”¨ä¾‹";
          pnpm test:e2e -- tests/e2e/header-layout.bbox.spec.ts
        else
          echo "â­ï¸  è·³è¿‡ E2E å¸ƒå±€å›å½’ (è®¾ç½® RUN_E2E_LAYOUT=1 å¯ç”¨)"
        fi
      fail_text: 'E2E å¸ƒå±€å›å½’å¤±è´¥ - header å¸ƒå±€å‘ç”Ÿé‡å /æº¢å‡º'

    # æ€§èƒ½æµ‹è¯• (ä»… CI ç¯å¢ƒè¿è¡Œ,é¿å…æœ¬åœ° headless Chrome å¡ä½)
    performance-test:
      run: |
        if [ -n "$CI" ]; then
          pnpm perf:check
        else
          echo "â­ï¸  è·³è¿‡æ€§èƒ½æµ‹è¯• (ä»… CI ç¯å¢ƒè¿è¡Œ)"
        fi
      fail_text: 'æ€§èƒ½æµ‹è¯•å¤±è´¥ - åŒ…å¤§å°æˆ–æ€§èƒ½æŒ‡æ ‡è¶…å‡ºé™åˆ¶'

    # å®‰å…¨æ£€æŸ¥ï¼ˆA+ï¼šæœ¬åœ°æ‰§è¡Œï¼›å¯ç”¨ RUN_FAST_PUSH=1 è·³è¿‡åº”æ€¥æ¨é€ï¼‰
    security-check:
      run: |
        if [ -n "$RUN_FAST_PUSH" ]; then
          echo "â­ï¸  RUN_FAST_PUSH=1: è·³è¿‡å®‰å…¨å®¡è®¡ï¼ˆä»…ç”¨äºç´§æ€¥æ¨é€ï¼ŒCI ä¼šå…œåº•ï¼‰";
        else
          pnpm security:audit
        fi
      fail_text: 'å®‰å…¨æ£€æŸ¥å¤±è´¥ - å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·ä¿®å¤åæ¨é€'
