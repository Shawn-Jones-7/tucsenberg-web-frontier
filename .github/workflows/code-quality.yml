name: ä¼ä¸šçº§ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  code-quality:
    name: ä»£ç è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: TypeScriptç±»åž‹æ£€æŸ¥
        run: pnpm run type-check

      - name: æµ‹è¯•æ–‡ä»¶ç±»åž‹æ£€æŸ¥
        run: pnpm run type-check:tests

      - name: ESLintä»£ç æ£€æŸ¥
        run: pnpm run lint:check

      - name: ä¼ä¸šçº§è´¨é‡é—¨ç¦
        run: pnpm run quality:gate

      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: reports/quality/
          retention-days: 30

      - name: è´¨é‡è¶‹åŠ¿åˆ†æž
        if: github.event_name == 'push'
        run: |
          echo "ðŸ“Š è´¨é‡è¶‹åŠ¿åˆ†æž"
          if [ -f "reports/quality/latest-quality-summary.json" ]; then
            echo "å½“å‰è´¨é‡åˆ†æ•°: $(cat reports/quality/latest-quality-summary.json | jq '.qualityScore')"
            echo "é”™è¯¯æ•°é‡: $(cat reports/quality/latest-quality-summary.json | jq '.totalErrors')"
            echo "è­¦å‘Šæ•°é‡: $(cat reports/quality/latest-quality-summary.json | jq '.totalWarnings')"
          fi

      - name: è´¨é‡é—¨ç¦å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ ä»£ç è´¨é‡é—¨ç¦æœªé€šè¿‡"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹é—®é¢˜ï¼š"
          echo "1. ç¡®ä¿æ²¡æœ‰TypeScriptç±»åž‹é”™è¯¯"
          echo "2. ä¿®å¤æ‰€æœ‰ESLinté”™è¯¯"
          echo "3. å°†è­¦å‘Šæ•°é‡æŽ§åˆ¶åœ¨500ä¸ªä»¥ä¸‹"
          echo "4. ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨anyç±»åž‹"
          exit 1

  security-audit:
    name: å®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ä¾èµ–å®‰å…¨å®¡è®¡
        run: pnpm run security:audit

      - name: æž¶æž„ä¾èµ–æ£€æŸ¥
        run: pnpm run arch:check

      - name: å¾ªçŽ¯ä¾èµ–æ£€æŸ¥
        run: pnpm run circular:check

  test-quality:
    name: æµ‹è¯•è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œæµ‹è¯•
        run: pnpm run test

      - name: æµ‹è¯•è¦†ç›–çŽ‡æ£€æŸ¥
        run: pnpm run test:coverage
        continue-on-error: true

      - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

  quality-summary:
    name: è´¨é‡æ€»ç»“
    runs-on: ubuntu-latest
    needs: [code-quality, security-audit, test-quality]
    if: always()
    timeout-minutes: 6

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½è´¨é‡æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: quality-reports
          path: reports/quality/

      - name: ç”Ÿæˆè´¨é‡æ€»ç»“
        run: |
          echo "## ðŸŽ¯ ä¼ä¸šçº§ä»£ç è´¨é‡æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "reports/quality/latest-quality-summary.json" ]; then
            QUALITY_SCORE=$(cat reports/quality/latest-quality-summary.json | jq '.qualityScore')
            TOTAL_ERRORS=$(cat reports/quality/latest-quality-summary.json | jq '.totalErrors')
            TOTAL_WARNINGS=$(cat reports/quality/latest-quality-summary.json | jq '.totalWarnings')

            echo "### ðŸ“Š è´¨é‡æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
            echo "- **è´¨é‡åˆ†æ•°**: ${QUALITY_SCORE}/100" >> $GITHUB_STEP_SUMMARY
            echo "- **é”™è¯¯æ•°é‡**: ${TOTAL_ERRORS}" >> $GITHUB_STEP_SUMMARY
            echo "- **è­¦å‘Šæ•°é‡**: ${TOTAL_WARNINGS}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$TOTAL_ERRORS" -eq 0 ] && [ "$TOTAL_WARNINGS" -le 500 ]; then
              echo "âœ… **è´¨é‡é—¨ç¦**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **è´¨é‡é—¨ç¦**: æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ è´¨é‡æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” æ£€æŸ¥é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
          echo "- [x] TypeScriptç±»åž‹æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ESLintä»£ç è§„èŒƒæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å®‰å…¨æ¼æ´žæ‰«æ" >> $GITHUB_STEP_SUMMARY
          echo "- [x] æž¶æž„ä¾èµ–åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å¾ªçŽ¯ä¾èµ–æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å•å…ƒæµ‹è¯•æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
