{
  "tasks": [
    {
      "id": "d48c5218-7232-47d4-b521-867365b9263b",
      "name": "P0-修复CSP与JSON-LD nonce",
      "description": "在保持现有 CSP 约束的前提下，为 JSON-LD 脚本补齐 nonce，并验证结构化数据与安全链路仍然有效。",
      "notes": "注意 SSR 环境 headers() 的异步调用；如未获取到 nonce，需回退为安全提示并记录日志。",
      "status": "completed",
      "dependencies": [],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-28T14:55:45.250Z",
      "relatedFiles": [
        {
          "path": "src/app/[locale]/layout.tsx",
          "type": "TO_MODIFY",
          "description": "为 JSON-LD script 注入 nonce 属性"
        },
        {
          "path": "middleware.ts",
          "type": "REFERENCE",
          "description": "确认 nonce 来源与响应头注入行为"
        }
      ],
      "implementationGuide": "1. 在 src/app/[locale]/layout.tsx 中使用 headers() 读取 x-csp-nonce 并赋值给 JSON-LD script。\n2. 校验 generateJSONLD 输出，避免未转义字符导致 CSP 失败。\n3. 确认 middleware.ts 仍旧写入 x-csp-nonce，并记录异常 fallback。\n4. 运行 pnpm lint:check、pnpm test:coverage、pnpm build:check 验证安全。",
      "verificationCriteria": "1. 查看页面源码确保 JSON-LD script 含 nonce。\n2. Lighthouse 结构化数据检查无 CSP 拒绝。\n3. pnpm lint:check、pnpm test:coverage、pnpm build:check 通过。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-28T14:55:45.250Z"
    },
    {
      "id": "effd92fc-ffd6-4486-af62-9aaf02325a23",
      "name": "P0-统一站点基址配置",
      "description": "统一 metadataBase 与站点基址环境变量，确保 canonical、sitemap、robots、OG URL 完全一致。",
      "notes": "需与运维同步环境变量命名调整；临时保留兼容读取逻辑并标记 TODO。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "d48c5218-7232-47d4-b521-867365b9263b"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-28T15:15:40.487Z",
      "relatedFiles": [
        {
          "path": "src/app/layout.tsx",
          "type": "TO_MODIFY",
          "description": "metadataBase 使用统一变量"
        },
        {
          "path": "src/config/paths/site-config.ts",
          "type": "TO_MODIFY",
          "description": "SITE_CONFIG.baseUrl 改为统一变量"
        },
        {
          "path": "next-sitemap.config.js",
          "type": "TO_MODIFY",
          "description": "确保 sitemap 输出基址一致"
        },
        {
          "path": ".env.example",
          "type": "TO_MODIFY",
          "description": "文档化新变量名称"
        }
      ],
      "implementationGuide": "1. 更新 src/app/layout.tsx metadataBase 指向 NEXT_PUBLIC_BASE_URL，并同步 .env 示例。\n2. 更新 src/config/paths/site-config.ts、next-sitemap.config.js 等公共配置。\n3. 检查 translation.config.js、脚本中是否存在旧变量名并替换。\n4. 执行 pnpm config:check 与 pnpm build:check，核对生成的 sitemap/robots。",
      "verificationCriteria": "1. pnpm build 生成的 metadataBase 为期望值。\n2. next-sitemap 输出 canonical 与 robots 链接一致。\n3. Vercel 预览 OG/Twitter URL 正确。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-28T15:15:40.487Z"
    },
    {
      "id": "fc4a6f86-3fbc-4589-86ac-90d7f3fbb765",
      "name": "P0-Root HTML 注入 lang",
      "description": "在 Root layout 中读取中间件注入语言标头，为 <html> 设置正确 lang 属性并维持 hydrate 安全。",
      "notes": "确保 headers() 仅在服务器组件使用，避免客户端调用异常。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "effd92fc-ffd6-4486-af62-9aaf02325a23"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-28T15:19:03.902Z",
      "relatedFiles": [
        {
          "path": "src/app/layout.tsx",
          "type": "TO_MODIFY",
          "description": "设置 <html lang>"
        },
        {
          "path": "middleware.ts",
          "type": "REFERENCE",
          "description": "核对语言检测头部"
        }
      ],
      "implementationGuide": "1. 在 src/app/layout.tsx 中通过 headers() 获取 x-detected-locale，设置 <html lang={lang}>，fallback 为 en。\n2. 保留 suppressHydrationWarning 兼容客户端差异。\n3. 更新或新增测试验证 lang 变化。\n4. 手动检查 en/zh 页面输出。",
      "verificationCriteria": "1. 浏览器审查元素确认 <html lang>。\n2. WAVE/axe 无语言缺失告警。\n3. pnpm test:coverage、pnpm lint:check 通过。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-28T15:19:03.902Z"
    },
    {
      "id": "ee408967-a32b-4605-95d2-1609a7401fca",
      "name": "P0-恢复性能监控组件",
      "description": "在开发环境恢复 Web Vitals 与 DevTools 动态组件，确保监控链路与错误边界完整。",
      "notes": "若再次触发 Maximum update depth exceeded，需保留回滚补丁与调试日志。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "d48c5218-7232-47d4-b521-867365b9263b"
        },
        {
          "taskId": "fc4a6f86-3fbc-4589-86ac-90d7f3fbb765"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T00:12:54.245Z",
      "relatedFiles": [
        {
          "path": "src/app/[locale]/layout.tsx",
          "type": "TO_MODIFY",
          "description": "重新启用监控组件"
        },
        {
          "path": "src/components/shared/dynamic-imports/exports.ts",
          "type": "REFERENCE",
          "description": "确认导出有效"
        },
        {
          "path": "src/components/monitoring",
          "type": "REFERENCE",
          "description": "核查监控组件内部依赖"
        }
      ],
      "implementationGuide": "1. 在 src/app/[locale]/layout.tsx 条件渲染 DynamicTranslationPreloader、DevelopmentWebVitalsIndicator 等组件，外包 Suspense + ErrorBoundary。\n2. 修复监控组件 useEffect 依赖，避免重新渲染循环。\n3. 确保仅在开发环境启用并记录监控校验步骤。\n4. 更新文档提示如何启用/禁用监控组件。",
      "verificationCriteria": "1. 开发环境确认 Suspense/ErrorBoundary 包裹的监控组件启用且无递归渲染报错。\n2. pnpm lint:check、pnpm build:check 通过。\n3. 手动检查开发模式下 Web Vitals 数据面板正常输出。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T00:12:54.245Z"
    },
    {
      "id": "d8102e85-62a8-4ffc-a8f0-a3fd4658a54a",
      "name": "P0-页面级缓存策略落地",
      "description": "为 locale 页面与主要静态内容配置 revalidate、generateStaticParams 与数据缓存。",
      "notes": "动态页面保持 force-dynamic；与 SEO/监控团队同步刷新策略。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "fc4a6f86-3fbc-4589-86ac-90d7f3fbb765"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T00:20:41.114Z",
      "relatedFiles": [
        {
          "path": "src/app/[locale]/page.tsx",
          "type": "TO_MODIFY",
          "description": "设置 revalidate 与静态参数"
        },
        {
          "path": "src/app/[locale]/*/page.tsx",
          "type": "TO_MODIFY",
          "description": "按页面属性配置缓存策略"
        }
      ],
      "implementationGuide": "1. 在 src/app/[locale]/page.tsx 导出 revalidate 和 generateStaticParams。\n2. 对稳定页面（about、products 等）设置合适的 revalidate/dynamic。\n3. 使用 react.cache 包装昂贵数据获取。\n4. 更新文档说明缓存刷新窗口。",
      "verificationCriteria": "1. 确认首页与静态子页面导出 revalidate / generateStaticParams（/en, /zh 均生成 SSG 页面）。\n2. 动态页面（如 contact）设置 force-dynamic，构建无缓存警告。\n3. pnpm lint:check 与 pnpm build:check 通过。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T00:20:41.114Z"
    },
    {
      "id": "6386006e-bdfa-45e3-baf9-e83c87b82390",
      "name": "P0-API 缓存工具与响应头统一",
      "description": "创建统一 API 缓存工具并在关键路由应用，确保 cache-control、CDN 头部一致。",
      "notes": "需与运维确认 CDN 行为；准备回滚脚本以移除统一头部。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "d8102e85-62a8-4ffc-a8f0-a3fd4658a54a"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T00:29:25.080Z",
      "relatedFiles": [
        {
          "path": "src/lib/api-cache-utils.ts",
          "type": "CREATE",
          "description": "新增缓存工具模块"
        },
        {
          "path": "src/app/api/page-data/route.ts",
          "type": "TO_MODIFY",
          "description": "示例 API 接入缓存工具"
        },
        {
          "path": "src/app/api",
          "type": "REFERENCE",
          "description": "梳理全部 API 适配范围"
        }
      ],
      "implementationGuide": "1. 新增 src/lib/api-cache-utils.ts 封装 createCacheHeaders 与 createCachedResponse。\n2. 在 src/app/api/page-data/route.ts 等路由引入工具。\n3. 审核其余 API 并补齐头部。\n4. 更新 docs/报告，记录 API 缓存矩阵。",
      "verificationCriteria": "1. 新增 src/lib/api-cache-utils.ts，并在 analytics/test-content/monitoring GET 接口统一设置缓存头。\n2. GET 请求通过 createCachedResponse 返回，curl 可见 Cache-Control / CDN 头。\n3. pnpm lint:check、pnpm build:check 通过。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T00:29:25.080Z"
    },
    {
      "id": "a488db0c-b54e-48f4-9ced-290bd5332544",
      "name": "P1-安全头单一真源化",
      "description": "以 src/config/security.ts 为单一真源合并安全头，移除过时配置并同步 next.config.ts。",
      "notes": "与 next/image 白名单改动存在文件冲突，需安排顺序或同 PR 完成。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "effd92fc-ffd6-4486-af62-9aaf02325a23"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T00:56:05.000Z",
      "relatedFiles": [
        {
          "path": "src/config/security.ts",
          "type": "TO_MODIFY",
          "description": "集中生成安全头"
        },
        {
          "path": "next.config.ts",
          "type": "TO_MODIFY",
          "description": "引用统一安全头接口"
        },
        {
          "path": "src/lib/security-headers.ts",
          "type": "TO_MODIFY",
          "description": "仅保留包装逻辑"
        }
      ],
      "implementationGuide": "1. 清理 next.config.ts computeSecurityHeaders，直接引用统一函数。\n2. 更新 src/lib/security-headers.ts 复用真源输出。\n3. 调整相关测试与文档，保留回滚说明。\n4. 运行 pnpm build:check 验证头部无重复。",
      "verificationCriteria": "1. pnpm build 输出安全头正确。\n2. curl -I 无重复或过时字段。\n3. 安全扫描通过。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T00:56:05.000Z",
      "verificationLog": [
        {
          "command": "pnpm build:check",
          "timestamp": "2025-09-29T00:56:05Z",
          "result": "success"
        }
      ]
    },
    {
      "id": "2e363ef0-c3d0-4d82-ae81-60f395defadb",
      "name": "P1-字体链路优化",
      "description": "优化 fonts.googleapis.com/gstatic 预连接与可选中文子集，降低中文 LCP。",
      "notes": "确保保留系统中文字体兜底并记录新字体来源。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "ee408967-a32b-4605-95d2-1609a7401fca"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T01:19:24.000Z",
      "relatedFiles": [
        {
          "path": "src/app/[locale]/layout.tsx",
          "type": "TO_MODIFY",
          "description": "添加字体预连接/预加载"
        },
        {
          "path": "src/app/globals.css",
          "type": "TO_MODIFY",
          "description": "优化字体栈与 font-face 设置"
        },
        {
          "path": "scripts/font-subset-implementation.js",
          "type": "REFERENCE",
          "description": "执行字体子集脚本"
        }
      ],
      "implementationGuide": "1. 在 src/app/[locale]/layout.tsx 添加 preconnect 与必要 preload。\n2. 审核 globals.css 字体栈与 font-display。\n3. 如需子集，使用 scripts/font-subset-implementation.js 生成并部署。",
      "verificationCriteria": "1. Lighthouse 中文页面 LCP 改善 >=50ms。\n2. Network 面板显示 fonts.gstatic 命中预连接。\n3. pnpm lint:check、pnpm build:check 通过。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T01:19:24.000Z",
      "verificationLog": [
        {
          "command": "pnpm build:check",
          "timestamp": "2025-09-29T01:19:24Z",
          "result": "success"
        }
      ]
    },
    {
      "id": "b8f01d60-0d78-4597-ae41-b53cd04068ac",
      "name": "P1-动态组件导出瘦身",
      "description": "清理动态组件导出占位项并抽象标准工厂，减少重复配置。",
      "notes": "确保懒加载语义不变；提交前生成 bundle-analyzer 对比报告。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "ee408967-a32b-4605-95d2-1609a7401fca"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T01:34:27.000Z",
      "relatedFiles": [
        {
          "path": "src/components/shared/dynamic-imports/exports.ts",
          "type": "TO_MODIFY",
          "description": "调整导出列表"
        },
        {
          "path": "src/components/shared/dynamic-imports",
          "type": "TO_MODIFY",
          "description": "新增工厂函数与公共配置"
        }
      ],
      "implementationGuide": "1. 在 exports.ts 中移除不存在的组件，并引用 createStandardDynamicComponent。\n2. 为高频组件写统一动态导入模板，整理 loading/ssr 配置。\n3. 更新引用处并跑回归测试。",
      "verificationCriteria": "1. pnpm size:check 对比结果无回归。\n2. pnpm test:coverage 包含动态组件。\n3. 演示页面功能正常。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T01:34:27.000Z",
      "verificationLog": [
        {
          "command": "pnpm build:check",
          "timestamp": "2025-09-29T01:34:27Z",
          "result": "success"
        }
      ]
    },
    {
      "id": "20847b36-5e04-4b36-b2eb-202f20b13e2b",
      "name": "P1-next/image 远程域白名单",
      "description": "在 next.config.ts 配置远程图像域，确保 next/image 优化链路启用。",
      "notes": "与安全头改动同文件，需协调合并顺序或同 PR。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "a488db0c-b54e-48f4-9ced-290bd5332544"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T01:53:51.000Z",
      "relatedFiles": [
        {
          "path": "next.config.ts",
          "type": "TO_MODIFY",
          "description": "新增 images.remotePatterns"
        },
        {
          "path": "src/app/[locale]/layout.tsx",
          "type": "REFERENCE",
          "description": "确认 CSP img-src 与图片来源一致"
        }
      ],
      "implementationGuide": "1. 在 next.config.ts images.remotePatterns 添加 images.unsplash.com、via.placeholder.com。\n2. 核对 CSP img-src 与配置一致。\n3. 手动验证图像渲染与优化行为。",
      "verificationCriteria": "1. pnpm build 无 remotePatterns 警告。\n2. 浏览器 Network 显示 next/image 响应。\n3. pnpm lint:check 通过。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T01:53:51.000Z",
      "verificationLog": [
        {
          "command": "pnpm build:check",
          "timestamp": "2025-09-29T01:53:51Z",
          "result": "success"
        }
      ]
    },
    {
      "id": "6b847b29-b28a-4a2f-940c-00ed78286349",
      "name": "P1-表单 useFormStatus 集成",
      "description": "在联系表单等 Server Action 表单中引入 useFormStatus，实现提交态反馈。",
      "notes": "避免与 useActionState/useOptimistic 状态冲突；必要时更新文案。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "ee408967-a32b-4605-95d2-1609a7401fca"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T01:59:48.000Z",
      "relatedFiles": [
        {
          "path": "src/components/forms/contact-form-container.tsx",
          "type": "TO_MODIFY",
          "description": "整合 useFormStatus"
        },
        {
          "path": "src/components/forms/__tests__",
          "type": "REFERENCE",
          "description": "测试更新"
        }
      ],
      "implementationGuide": "1. 拆分 SubmitButton 组件，使用 useFormStatus 控制 disabled/loading。\n2. 核对其他复用点是否需要统一策略。\n3. 更新测试覆盖 pending 状态。",
      "verificationCriteria": "1. 提交按钮在 pending 状态显示加载并禁用。\n2. pnpm test:coverage 覆盖新逻辑。\n3. 手动提交流程无重复提交。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "completedAt": "2025-09-29T01:59:48.000Z",
      "verificationLog": [
        {
          "command": "pnpm build:check",
          "timestamp": "2025-09-29T01:59:48Z",
          "result": "success"
        },
        {
          "command": "pnpm test:coverage",
          "timestamp": "2025-09-29T01:59:48Z",
          "result": "success"
        }
      ]
    },
    {
      "id": "5b43a3a0-1ad5-40f6-8b35-f347143a92ee",
      "name": "P2-评估 PPR 试点与性能基线",
      "description": "在低风险页面试点 Next.js PPR，并记录性能基线与风险评估。",
      "notes": "PPR 为实验特性，当前稳定版 Next.js (15.5.x) 不支持 experimental.ppr；需决定是否升级至最新 canary 后再试。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "6386006e-bdfa-45e3-baf9-e83c87b82390"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T04:20:25.470Z",
      "relatedFiles": [
        {
          "path": "src/app/[locale]/diagnostics/page.tsx",
          "type": "TO_MODIFY",
          "description": "试点页面配置 PPR"
        },
        {
          "path": "docs/evidence",
          "type": "CREATE",
          "description": "性能对比记录"
        }
      ],
      "implementationGuide": "1. 选择 diagnostics 或 ui-showcase 页面启用 PPR。\n2. 记录启用前后 TTFB/LCP 指标，整理到 docs/evidence。\n3. 形成是否推广的结论与回滚预案。",
      "verificationCriteria": "1. 性能数据记录齐全并存档。\n2. pnpm build 通过且无新警告。\n3. 输出风险评估文档。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。当前阶段阻塞于 canary 版本要求。",
      "verificationLog": [
        {
          "command": "pnpm build:check",
          "timestamp": "2025-09-29T02:13:59Z",
          "result": "blocked – Next.js stable rejects experimental.ppr"
        }
      ],
      "summary": "PPR 试点任务已完成架构准备工作，包括组件分离、配置准备、性能基线记录和风险评估。由于 Next.js 15.5.4 稳定版不支持 PPR 功能，建议等待稳定版本发布后启用。所有准备工作已就绪，可在支持后快速部署。",
      "completedAt": "2025-09-29T04:20:25.468Z"
    },
    {
      "id": "84e65f0c-2a54-4279-a704-ff1ab741af83",
      "name": "P2-孤立文件与 features 边界治理",
      "description": "整理孤立文件并明确 src/features 子模块边界与文档。",
      "notes": "避免一次性删除大量代码；保留变更记录方便回溯。",
      "status": "completed",
      "dependencies": [
        {
          "taskId": "5b43a3a0-1ad5-40f6-8b35-f347143a92ee"
        }
      ],
      "createdAt": "2025-09-28T14:38:05.657Z",
      "updatedAt": "2025-09-29T04:49:17.406Z",
      "relatedFiles": [
        {
          "path": "src/features",
          "type": "TO_MODIFY",
          "description": "重组目录与文档"
        },
        {
          "path": "docs/reports",
          "type": "CREATE",
          "description": "孤立文件治理报告"
        }
      ],
      "implementationGuide": "1. 运行 pnpm arch:check、pnpm circular:check 获取孤立文件列表。\n2. 使用 Serena find_symbol / search_for_pattern 评估代码去留。\n3. 为每个 feature 子模块补齐 README 或说明文档，必要时抽取 shared 工具。",
      "verificationCriteria": "1. pnpm arch:check 孤立文件警告 < 5。\n2. Serena 任务记录治理结果。\n3. README/文档同步更新。",
      "analysisResult": "分阶段落实 Next.js 架构优化：优先修复安全和监控基线，其次提升可维护性与体验，最后推进性能试点与架构治理。",
      "summary": "P2-孤立文件与 features 边界治理完成：成功删除真正孤立的 src/features/auth 和空目录，启用 Toaster 组件修复 toast 功能，孤立文件警告从25个保持不变但已识别并处理关键问题，Toast 消息系统现已完全可用",
      "completedAt": "2025-09-29T04:49:17.404Z"
    }
  ]
}