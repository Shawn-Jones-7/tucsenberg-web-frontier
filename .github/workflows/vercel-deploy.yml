name: Vercel éƒ¨ç½²å¢å¼º

# æ­¤ workflow ä½œä¸º Vercå°” GitHub é›†æˆçš„è¡¥å……
# ä¸»è¦ç”¨äºéƒ¨ç½²å‰çš„é¢å¤–è´¨é‡æ£€æŸ¥å’Œéƒ¨ç½²åçš„éªŒè¯

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.sha }}
  cancel-in-progress: true

jobs:
  # éƒ¨ç½²å‰è´¨é‡æ£€æŸ¥
  pre-deployment-checks:
    name: éƒ¨ç½²å‰è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false
          persist-credentials: false

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ç±»å‹æ£€æŸ¥
        run: pnpm type-check

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: pnpm lint:check

      - name: æ„å»ºéªŒè¯
        run: pnpm build:check

      - name: ç¿»è¯‘éªŒè¯
        run: pnpm validate:translations

      - name: è´¨é‡é—¨ç¦
        run: pnpm quality:gate

  # åŸºäº Token çš„ Vercel éƒ¨ç½²
  deploy-to-vercel:
    name: éƒ¨ç½²åˆ° Vercelï¼ˆtokenï¼‰
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    timeout-minutes: 15
    if: github.event_name != 'workflow_dispatch'

    outputs:
      preview_url: ${{ steps.vercel_cli_deploy.outputs.deployment-url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false

          submodules: false

      # ç¡®ä¿å…ˆå®‰è£… pnpmï¼Œå†å¯ç”¨ setup-node çš„ pnpm ç¼“å­˜ï¼Œé¿å…ç¼“å­˜é˜¶æ®µæ‰¾ä¸åˆ° pnpm
      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1
          run_install: false
          standalone: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£… Vercel CLI
        run: npm i -g vercel@latest
        env:
          CI: true

      - name: æ‹‰å– Vercel ç¯å¢ƒé…ç½® (preview)
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: è¯Šæ–­ Vercel å…³è”ä¸ç‰ˆæœ¬
        run: |
          set -euo pipefail
          vercel --version
          node -v
          pnpm -v
          echo "é¡¹ç›®å…³è”æ–‡ä»¶ (.vercel/project.json):"
          if [ -f .vercel/project.json ]; then
            cat .vercel/project.json || true
          else
            echo "(ç¼ºå¤±)"
          fi
          echo "é¢„è§ˆç¯å¢ƒå˜é‡æ–‡ä»¶ (.vercel/.env.preview.local) å­˜åœ¨æ€§:"
          if [ -f .vercel/.env.preview.local ]; then
            head -n 20 .vercel/.env.preview.local || true
          else
            echo "(ç¼ºå¤±)"
          fi

      - name: å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆæ˜¾å¼ï¼‰
        run: pnpm install --frozen-lockfile

      - name: ä½¿ç”¨ Vercel CLI æ„å»ºï¼ˆä¿å­˜æ—¥å¿—ï¼‰
        id: vercel_build
        run: |
          set -euo pipefail
          # å°† stdout + stderr ä¸€å¹¶ä¿å­˜ï¼Œä¾›åç»­è´¨é‡æ‹¦æˆªæ­¥éª¤ä½¿ç”¨
          VERCEL_LOGS=1 VERCEL_BUILDER_DEBUG=1 vercel build --token=${{ secrets.VERCEL_TOKEN }} --debug --yes 2>&1 | tee vercel_build.log
          echo "log-path=$(pwd)/vercel_build.log" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          CI: true

      - name: é˜»æ–­ï¼šæ£€æµ‹ next-intl MISSING_MESSAGE
        run: |
          set -euo pipefail
          if grep -E -i "MISSING_MESSAGE" vercel_build.log; then
            echo "âŒ Detected next-intl MISSING_MESSAGE in Vercel build logs"
            exit 1
          else
            echo "âœ… No MISSING_MESSAGE found in Vercel build logs"
          fi

      - name: ä¸Šä¼  Vercel æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vercel_build.log
          path: vercel_build.log
          if-no-files-found: ignore

      - name: é€šè¿‡ Token éƒ¨ç½²é¢„æ„å»ºäº§ç‰©
        id: vercel_cli_deploy
        run: |
          set -euo pipefail
          DEPLOY_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment-url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"
          echo "VERCEL_DEPLOYMENT_URL=${DEPLOY_URL}" >> "$GITHUB_ENV"
          echo "éƒ¨ç½² URL: ${DEPLOY_URL}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: è°ƒè¯•è¾“å‡ºéƒ¨ç½² URLï¼ˆæ‘˜è¦ï¼‰
        if: always()
        run: |
          echo "preview_url=${{ steps.vercel_cli_deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "preview_url=${{ steps.vercel_cli_deploy.outputs.deployment-url }}"

  # åŸºäº Token çš„ Vercel ç”Ÿäº§éƒ¨ç½²
  deploy-to-vercel-prod:
    name: éƒ¨ç½²åˆ° Productionï¼ˆ--prodï¼‰
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    timeout-minutes: 15
    if: github.event_name == 'workflow_dispatch'

    outputs:
      prod_url: ${{ steps.vercel_cli_deploy_prod.outputs.deployment-url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false
          persist-credentials: false

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1
          run_install: false
          standalone: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£… Vercel CLI
        run: npm i -g vercel@latest
        env:
          CI: true

      - name: æ‹‰å– Vercel ç¯å¢ƒé…ç½® (production)
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆæ˜¾å¼ï¼‰
        run: pnpm install --frozen-lockfile

      - name: ä½¿ç”¨ Vercel CLI æ„å»ºï¼ˆä¿å­˜æ—¥å¿—ï¼Œprodï¼‰
        id: vercel_build_prod
        run: |
          set -euo pipefail
          VERCEL_LOGS=1 VERCEL_BUILDER_DEBUG=1 vercel build --prod --token=${{ secrets.VERCEL_TOKEN }} --debug --yes 2>&1 | tee vercel_build_prod.log
          echo "log-path=$(pwd)/vercel_build_prod.log" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          CI: true

      - name: é˜»æ–­ï¼šæ£€æµ‹ next-intl MISSING_MESSAGEï¼ˆprodï¼‰
        run: |
          set -euo pipefail
          if grep -E -i "MISSING_MESSAGE" vercel_build_prod.log; then
            echo "âŒ Detected next-intl MISSING_MESSAGE in Vercel prod build logs"
            exit 1
          else
            echo "âœ… No MISSING_MESSAGE found in Vercel prod build logs"
          fi

      - name: ä¸Šä¼  Vercel æ„å»ºæ—¥å¿—ï¼ˆprodï¼‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vercel_build_prod.log
          path: vercel_build_prod.log
          if-no-files-found: ignore

      - name: é€šè¿‡ Token éƒ¨ç½²åˆ° Productionï¼ˆ--prodï¼‰
        id: vercel_cli_deploy_prod
        run: |
          set -euo pipefail
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment-url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"
          echo "PROD_DEPLOYMENT_URL=${DEPLOY_URL}" >> "$GITHUB_ENV"
          echo "ç”Ÿäº§éƒ¨ç½² URL: ${DEPLOY_URL}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # éƒ¨ç½²åéªŒè¯ (ä»…åœ¨æœ‰éƒ¨ç½² URL æ—¶è¿è¡Œ)
  post-deployment-verification:
    name: éƒ¨ç½²åéªŒè¯
    runs-on: ubuntu-latest
    needs: deploy-to-vercel
    timeout-minutes: 15
    if: needs.deploy-to-vercel.outputs.preview_url != ''

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false
          persist-credentials: false

      - name: ç­‰å¾…éƒ¨ç½²å°±ç»ªï¼ˆå¢å¼ºç‰ˆï¼‰
        run: |
          set -euo pipefail
          url="${{ needs.deploy-to-vercel.outputs.preview_url }}"
          echo "ç­‰å¾…éƒ¨ç½²å°±ç»ª: $url"

          max_tries=60       # æœ€é•¿ 60 æ¬¡æ¢æµ‹
          delay=5            # åˆå§‹ç­‰å¾… 5 ç§’

          for i in $(seq 1 $max_tries); do
            # å…ˆ HEADï¼ˆæ›´è½»é‡ï¼‰ï¼Œå¤±è´¥å† GET - æ·»åŠ  Protection Bypass header
            status=$(curl -s -o /dev/null -w "%{http_code}" -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" -I "$url" || echo "000")
            if [ "$status" = "000" ]; then
              status=$(curl -s -o /dev/null -w "%{http_code}" -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$url" || echo "000")
            fi

            echo "ç¬¬ $i æ¬¡æ¢æµ‹: $status"
            if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
              echo "éƒ¨ç½²å·²å°±ç»ª"
              exit 0
            fi

            # å¯¹å¸¸è§å†·å¯åŠ¨/ä¼ æ’­ä¸­çš„çŠ¶æ€åšé€€é¿
            case "$status" in
              000|404|425|429|500|502|503|504)
                ;;
              *)
                ;;
            esac

            # æ¯ 10 æ¬¡åŠ å¤§ç­‰å¾… 5 ç§’ï¼Œä¸Šé™ 20 ç§’
            if [ $((i % 10)) -eq 0 ] && [ "$delay" -lt 20 ]; then
              delay=$((delay + 5))
            fi
            sleep "$delay"
          done
          echo "ç­‰å¾…è¶…æ—¶ï¼Œéƒ¨ç½²æœªå°±ç»ª" >&2
          exit 1

      - name: éªŒè¯éƒ¨ç½²å¥åº·çŠ¶æ€
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-to-vercel.outputs.preview_url }}"

          # æ£€æŸ¥æ ¹è·¯å¾„
          echo "æ£€æŸ¥æ ¹è·¯å¾„..."
          curl -f -s -o /dev/null -w "%{http_code}" -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$DEPLOYMENT_URL" || exit 1

          # æ£€æŸ¥è‹±æ–‡è·¯ç”±
          echo "æ£€æŸ¥è‹±æ–‡è·¯ç”±..."
          curl -f -s -o /dev/null -w "%{http_code}" -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$DEPLOYMENT_URL/en" || exit 1

          # æ£€æŸ¥ä¸­æ–‡è·¯ç”±
          echo "æ£€æŸ¥ä¸­æ–‡è·¯ç”±..."
          curl -f -s -o /dev/null -w "%{http_code}" -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$DEPLOYMENT_URL/zh" || exit 1

          echo "âœ… æ‰€æœ‰è·¯ç”±éªŒè¯é€šè¿‡"

      - name: éªŒè¯ API ç«¯ç‚¹
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-to-vercel.outputs.preview_url }}"

          # æ£€æŸ¥ robots.txt
          echo "æ£€æŸ¥ robots.txt..."
          curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$DEPLOYMENT_URL/robots.txt" | grep -q "User-agent" || exit 1

          # æ£€æŸ¥ sitemap.xml - æ”¯æŒ sitemapindex å’Œ urlset ä¸¤ç§æ ¼å¼
          echo "æ£€æŸ¥ sitemap.xml..."
          SITEMAP_CONTENT=$(curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$DEPLOYMENT_URL/sitemap.xml")

          # æ£€æµ‹ sitemap æ ¼å¼
          if echo "$SITEMAP_CONTENT" | grep -q '<sitemapindex'; then
            echo "âœ“ Sitemap index format detected"
            echo "Checking sitemap-0.xml..."

            # éªŒè¯ sitemap-0.xml å­˜åœ¨ä¸”åŒ…å« urlset
            SITEMAP_0_CONTENT=$(curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$DEPLOYMENT_URL/sitemap-0.xml")

            if echo "$SITEMAP_0_CONTENT" | grep -q '<urlset'; then
              # ç»Ÿè®¡ URL æ•°é‡
              URL_COUNT=$(echo "$SITEMAP_0_CONTENT" | grep -o '<loc>' | wc -l)
              echo "âœ“ Found $URL_COUNT URLs in sitemap-0.xml"

              # éªŒè¯ URL æ•°é‡ï¼ˆæœŸæœ›è‡³å°‘ 20 ä¸ªï¼‰
              if [ "$URL_COUNT" -lt 20 ]; then
                echo "âŒ URL count is too low: $URL_COUNT (expected >= 20)"
                exit 1
              fi
            else
              echo "âŒ sitemap-0.xml does not contain urlset"
              exit 1
            fi
          elif echo "$SITEMAP_CONTENT" | grep -q '<urlset'; then
            echo "âœ“ Sitemap urlset format detected"

            # ç»Ÿè®¡ URL æ•°é‡
            URL_COUNT=$(echo "$SITEMAP_CONTENT" | grep -o '<loc>' | wc -l)
            echo "âœ“ Found $URL_COUNT URLs in sitemap.xml"

            # éªŒè¯ URL æ•°é‡
            if [ "$URL_COUNT" -lt 20 ]; then
              echo "âŒ URL count is too low: $URL_COUNT (expected >= 20)"
              exit 1
            fi
          else
            echo "âŒ Invalid sitemap format"
            echo "Content preview:"
            echo "$SITEMAP_CONTENT" | head -n 20
            exit 1
          fi

          echo "âœ… API ç«¯ç‚¹éªŒè¯é€šè¿‡"

  # éƒ¨ç½²æ€»ç»“

  # ç”Ÿäº§ç¯å¢ƒéªŒè¯ (ä»…åœ¨æœ‰ç”Ÿäº§ URL æ—¶è¿è¡Œ)
  post-deployment-verification-prod:
    name: ç”Ÿäº§ç¯å¢ƒéªŒè¯
    runs-on: ubuntu-latest
    needs: deploy-to-vercel-prod
    timeout-minutes: 15
    if: needs.deploy-to-vercel-prod.outputs.prod_url != ''

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false
          persist-credentials: false

      - name: ç­‰å¾…ç”Ÿäº§éƒ¨ç½²å°±ç»ª
        run: |
          set -euo pipefail
          url="${{ needs.deploy-to-vercel-prod.outputs.prod_url }}"
          echo "ç­‰å¾…ç”Ÿäº§éƒ¨ç½²å°±ç»ª: $url"

          max_tries=60
          delay=5

          for i in $(seq 1 $max_tries); do
            status=$(curl -s -o /dev/null -w "%{http_code}" -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" -I "$url" || echo "000")
            if [ "$status" = "000" ]; then
              status=$(curl -s -o /dev/null -w "%{http_code}" -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$url" || echo "000")
            fi

            echo "ç¬¬ $i æ¬¡æ¢æµ‹: $status"
            if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
              echo "éƒ¨ç½²å·²å°±ç»ª"; exit 0
            fi

            if [ $((i % 10)) -eq 0 ] && [ "$delay" -lt 20 ]; then delay=$((delay+5)); fi
            sleep "$delay"
          done
          echo "ç­‰å¾…è¶…æ—¶ï¼Œéƒ¨ç½²æœªå°±ç»ª" >&2; exit 1

      - name: å¥åº·æ£€æŸ¥ + å¤šè¯­è¨€æŠ½æ ·
        run: |
          set -euo pipefail
          BASE="${{ needs.deploy-to-vercel-prod.outputs.prod_url }}"
          echo "æ£€æŸ¥æ ¹è·¯å¾„..."; curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$BASE" > /dev/null
          echo "æ£€æŸ¥è‹±æ–‡é¦–é¡µ..."; curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$BASE/en" > /dev/null
          echo "æ£€æŸ¥ä¸­æ–‡é¦–é¡µ..."; curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$BASE/zh" > /dev/null
          echo "æ£€æŸ¥ robots.txt..."; curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$BASE/robots.txt" | grep -q "User-agent"
          echo "æ£€æŸ¥ sitemap.xml..."; curl -f -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" "$BASE/sitemap.xml" | head -n 5
          echo "âœ… å¥åº·æ£€æŸ¥ä¸å¤šè¯­è¨€æŠ½æ ·é€šè¿‡"

  deployment-summary:
    name: éƒ¨ç½²æ€»ç»“
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-to-vercel]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ç”Ÿæˆéƒ¨ç½²æ€»ç»“
        run: |
          echo "## ğŸš€ Vercel éƒ¨ç½²æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½² URL**: ${{ needs.deploy-to-vercel.outputs.preview_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.pre-deployment-checks.conclusion }}" == "success" ] && \
             [ "${{ needs.deploy-to-vercel.conclusion }}" == "success" ]; then
            echo "âœ… **çŠ¶æ€**: éƒ¨ç½²æˆåŠŸå¹¶é€šè¿‡æ‰€æœ‰éªŒè¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çŠ¶æ€**: éƒ¨ç½²å¤±è´¥æˆ–éªŒè¯æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“‹ ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "- éƒ¨ç½²å‰æ£€æŸ¥: ${{ needs.pre-deployment-checks.conclusion }}" >> $GITHUB_STEP_SUMMARY
            echo "- Vercel éƒ¨ç½²: ${{ needs.deploy-to-vercel.conclusion }}" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ needs.deploy-to-vercel.outputs.preview_url }}" ]; then
              echo "- éƒ¨ç½²åéªŒè¯: (å‚è€ƒè¿è¡Œè®°å½•)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- éƒ¨ç½²åéªŒè¯: skippedï¼ˆæ—  preview_urlï¼‰" >> $GITHUB_STEP_SUMMARY
            fi
          fi
