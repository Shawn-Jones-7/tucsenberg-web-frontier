name: ä¼ä¸šçº§ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  code-quality:
    name: ä»£ç è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: TypeScriptç±»å‹æ£€æŸ¥
        run: pnpm run type-check

      - name: æµ‹è¯•æ–‡ä»¶ç±»å‹æ£€æŸ¥
        run: pnpm run type-check:tests

      - name: ESLintä»£ç æ£€æŸ¥
        run: pnpm run lint:check

      - name: å¤åˆ¶ç¿»è¯‘èµ„æºåˆ° public
        run: node scripts/copy-translations.js

      - name: i18n å½¢çŠ¶ç­‰ä»·æ£€æŸ¥
        run: pnpm i18n:shape:check

      - name: ä¸Šä¼  i18n å½¢çŠ¶æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: i18n-shape-report.json
          path: reports/i18n-shape-report.json
          if-no-files-found: ignore

      - name: ä¼ä¸šçº§è´¨é‡é—¨ç¦
        run: pnpm run quality:gate

      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: reports/quality/
          retention-days: 30

      - name: è´¨é‡è¶‹åŠ¿åˆ†æ
        if: github.event_name == 'push'
        run: |
          echo "ğŸ“Š è´¨é‡è¶‹åŠ¿åˆ†æ"
          if [ -f "reports/quality/latest-quality-summary.json" ]; then
            echo "å½“å‰è´¨é‡åˆ†æ•°: $(cat reports/quality/latest-quality-summary.json | jq '.qualityScore')"
            echo "é”™è¯¯æ•°é‡: $(cat reports/quality/latest-quality-summary.json | jq '.totalErrors')"
            echo "è­¦å‘Šæ•°é‡: $(cat reports/quality/latest-quality-summary.json | jq '.totalWarnings')"
          fi

      - name: è´¨é‡é—¨ç¦å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ ä»£ç è´¨é‡é—¨ç¦æœªé€šè¿‡"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹é—®é¢˜ï¼š"
          echo "1. ç¡®ä¿æ²¡æœ‰TypeScriptç±»å‹é”™è¯¯"
          echo "2. ä¿®å¤æ‰€æœ‰ESLinté”™è¯¯"
          echo "3. å°†è­¦å‘Šæ•°é‡æ§åˆ¶åœ¨500ä¸ªä»¥ä¸‹"
          echo "4. ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨anyç±»å‹"
          exit 1

  security-audit:
    name: å®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ä¾èµ–å®‰å…¨å®¡è®¡
        run: pnpm run security:audit

      - name: æ¶æ„ä¾èµ–æ£€æŸ¥
        run: pnpm run arch:check

      - name: å¾ªç¯ä¾èµ–æ£€æŸ¥
        run: pnpm run circular:check

  test-quality:
    name: æµ‹è¯•è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œæµ‹è¯•
        run: pnpm run test

      - name: æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
        run: pnpm run test:coverage
        continue-on-error: true

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

  quality-summary:
    name: è´¨é‡æ€»ç»“
    runs-on: ubuntu-latest
    needs: [code-quality, security-audit, test-quality]
    if: always()
    timeout-minutes: 6
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ä¸‹è½½è´¨é‡æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: quality-reports
          path: reports/quality/
        continue-on-error: true

      - name: æ£€æŸ¥ä¾èµ– Job çŠ¶æ€
        id: check-status
        run: |
          echo "code_quality=${{ needs.code-quality.result }}" >> $GITHUB_OUTPUT
          echo "security_audit=${{ needs.security-audit.result }}" >> $GITHUB_OUTPUT
          echo "test_quality=${{ needs.test-quality.result }}" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆè´¨é‡æ€»ç»“
        run: |
          echo "## ğŸ¯ ä¼ä¸šçº§ä»£ç è´¨é‡æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ˜¾ç¤ºå„ Job çŠ¶æ€
          echo "### ğŸ“‹ æ£€æŸ¥çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»£ç è´¨é‡é—¨ç¦**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®‰å…¨å®¡è®¡**: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•è´¨é‡æ£€æŸ¥**: ${{ needs.test-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "reports/quality/latest-quality-summary.json" ]; then
            QUALITY_SCORE=$(cat reports/quality/latest-quality-summary.json | jq '.qualityScore')
            TOTAL_ERRORS=$(cat reports/quality/latest-quality-summary.json | jq '.totalErrors')
            TOTAL_WARNINGS=$(cat reports/quality/latest-quality-summary.json | jq '.totalWarnings')

            echo "### ğŸ“Š è´¨é‡æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
            echo "- **è´¨é‡åˆ†æ•°**: ${QUALITY_SCORE}/100" >> $GITHUB_STEP_SUMMARY
            echo "- **é”™è¯¯æ•°é‡**: ${TOTAL_ERRORS}" >> $GITHUB_STEP_SUMMARY
            echo "- **è­¦å‘Šæ•°é‡**: ${TOTAL_WARNINGS}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$TOTAL_ERRORS" -eq 0 ] && [ "$TOTAL_WARNINGS" -le 500 ]; then
              echo "âœ… **è´¨é‡é—¨ç¦**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **è´¨é‡é—¨ç¦**: æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ è´¨é‡æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œä½†æ‰€æœ‰æ£€æŸ¥å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” æ£€æŸ¥é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
          echo "- [x] TypeScriptç±»å‹æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ESLintä»£ç è§„èŒƒæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å®‰å…¨æ¼æ´æ‰«æ" >> $GITHUB_STEP_SUMMARY
          echo "- [x] æ¶æ„ä¾èµ–åˆ†æ" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å¾ªç¯ä¾èµ–æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "- [x] å•å…ƒæµ‹è¯•æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY

      - name: è®¾ç½®æœ€ç»ˆçŠ¶æ€
        if: needs.code-quality.result == 'success' && needs.security-audit.result == 'success' && needs.test-quality.result == 'success'
        run: |
          echo "âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡"
          exit 0

      - name: æŠ¥å‘Šå¤±è´¥
        if: needs.code-quality.result != 'success' || needs.security-audit.result != 'success' || needs.test-quality.result != 'success'
        run: |
          echo "âŒ éƒ¨åˆ†è´¨é‡æ£€æŸ¥å¤±è´¥"
          exit 1
