rules:
  - id: nextjs-unsafe-dangerouslySetInnerHTML
    pattern-regex: 'dangerouslySetInnerHTML=\{\{__html:\s*\$[A-Za-z_][A-Za-z0-9_]*\}\}'
    message: '避免使用dangerouslySetInnerHTML，存在XSS风险'
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      technology: [nextjs, react]
      cwe: 'CWE-79: Cross-site Scripting (XSS)'
      owasp: 'A03:2021 - Injection'

  - id: hardcoded-api-keys
    pattern-regex: "(api[_-]?key|secret[_-]?key|access[_-]?token)\\s*[=:]\\s*['\"][a-zA-Z0-9]{20,}['\"]"
    message: '检测到硬编码的API密钥或访问令牌'
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      technology: [nodejs]
      cwe: 'CWE-798: Use of Hard-coded Credentials'
      owasp: 'A07:2021 - Identification and Authentication Failures'

  - id: unsafe-eval-usage
    pattern-either:
      - pattern: eval($ARG)
      - pattern: Function($ARG)
      - pattern: new Function($ARG)
    message: '避免使用eval()或Function构造器，存在代码注入风险'
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      technology: [nodejs]
      cwe:
        'CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code'
      owasp: 'A03:2021 - Injection'

  - id: nextjs-unsafe-redirect
    pattern-either:
      - pattern: |
          router.push($URL)
      - pattern: |
          router.replace($URL)
      - pattern: |
          redirect($URL)
    message: '确保重定向URL经过验证，防止开放重定向攻击'
    languages: [typescript, javascript]
    severity: WARNING
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
        - "**/src/app/page.tsx"
    metadata:
      category: security
      technology: [nextjs]
      cwe: 'CWE-601: URL Redirection to Untrusted Site'
      owasp: 'A01:2021 - Broken Access Control'

  - id: insecure-random-generation
    patterns:
      - pattern: Math.random()
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
        - "**/scripts/**"
        - "**/tests/**"
        - "**/content/**"
        # Mock client - only used for dev/test, not security-sensitive
        - "**/src/lib/whatsapp/mock-client.ts"
    message: '避免使用不安全的随机数生成方法，使用crypto.randomBytes()或crypto.getRandomValues()'
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      technology: [nodejs]
      cwe:
        'CWE-338: Use of Cryptographically Weak Pseudo-Random Number Generator'
      owasp: 'A02:2021 - Cryptographic Failures'

  - id: nextjs-unsafe-html-injection
    pattern-either:
      - pattern: |
          $EL.innerHTML = $VAR
      - pattern: |
          $EL.outerHTML = $VAR
    message: '避免直接设置innerHTML/outerHTML，存在XSS风险'
    languages: [typescript, javascript]
    severity: ERROR
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
    metadata:
      category: security
      technology: [nextjs, react]
      cwe: 'CWE-79: Cross-site Scripting (XSS)'
      owasp: 'A03:2021 - Injection'

  - id: weak-crypto-algorithm
    pattern-either:
      - pattern: crypto.createHash('md5')
      - pattern: crypto.createHash('sha1')
      - pattern: crypto.createHmac('md5', $KEY)
      - pattern: crypto.createHmac('sha1', $KEY)
    message: '避免使用弱加密算法MD5和SHA1，推荐使用SHA-256或更强的算法'
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      technology: [nodejs]
      cwe: 'CWE-327: Use of a Broken or Risky Cryptographic Algorithm'
      owasp: 'A02:2021 - Cryptographic Failures'

  - id: sql-injection-risk
    pattern-either:
      - pattern: |
          $DB.query($QUERY + $VAR)
      - pattern: |
          $DB.execute($QUERY + $VAR)
      - pattern: |
          $DB.raw($QUERY + $VAR)
    message: '可能存在SQL注入风险，使用参数化查询或ORM'
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      technology: [nodejs, database]
      cwe: 'CWE-89: SQL Injection'
      owasp: 'A03:2021 - Injection'

  - id: nextjs-unsafe-server-action
    pattern: |
      export async function $FUNC(...$ARGS) {
        ...
        eval($VAR)
        ...
      }
    message: 'Server Actions中避免使用eval()，存在服务器端代码注入风险'
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      technology: [nextjs]
      cwe:
        'CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code'
      owasp: 'A03:2021 - Injection'

  - id: environment-variable-exposure
    pattern-regex: "console\\.(log|info|debug|warn|error)\\(.*process\\.env\\..*\\)"
    message: '避免在日志中暴露环境变量，可能包含敏感信息'
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      technology: [nodejs]
      cwe: 'CWE-532: Insertion of Sensitive Information into Log File'
      owasp: 'A09:2021 - Security Logging and Monitoring Failures'

  - id: object-injection-sink-dynamic-property
    patterns:
      - pattern-either:
          - pattern: $OBJ[$KEY]
          - pattern: $OBJ[$KEY] = $VALUE
      # Exclude string literal keys (single and double quotes)
      - pattern-not: $OBJ["$LIT"]
      - pattern-not: $OBJ['$LIT']
      # Exclude numeric literal indices
      - pattern-not: $OBJ[$NUM]
      - metavariable-regex:
          metavariable: $NUM
          regex: "^[0-9]+$"
      # Exclude for-loop index patterns
      - pattern-not-inside: |
          for (let $VAR = 0; $VAR < $OBJ.length; $VAR += 1) {
            ...
          }
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
        - "**/scripts/**"
        - "**/src/components/ui/**"
        - "**/components/ui/**"
        - "**/src/lib/security/object-guards.ts"
        - "**/src/lib/security-headers.ts"
        - "**/src/lib/dev-tools-positioning.ts"
        - "**/src/config/paths/utils.ts"
        - "**/src/config/contact-form-config.ts"
        - "**/src/services/**"
        - "**/src/shared/utils.ts"
        - "**/src/types/whatsapp-*/**"
        - "**/src/lib/validations.ts"
        - "**/src/lib/env.ts"
        - "**/src/lib/locale-detection-hooks.ts"
        - "**/src/testing/utils/theme-test-utilities.ts"
    message: '检测到对象注入漏洞：避免使用用户输入作为对象属性键，使用白名单验证或switch语句'
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'

  - id: object-injection-sink-spread-operator
    patterns:
      - pattern-either:
          - pattern: |
              {...$VAR}
          - pattern: |
              Object.assign($TARGET, $VAR)
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
        - "**/scripts/**"
        - "**/src/components/ui/**"
        - "**/components/ui/**"
        - "**/src/lib/performance-monitoring-core-config.ts"
        - "**/src/lib/i18n-cache-types-advanced.ts"
        - "**/src/lib/locale-storage-types-config/factory.ts"
        - "**/src/lib/theme-analytics-core.ts"
        - "**/src/lib/theme-analytics.ts"
        - "**/src/lib/web-vitals/**"
        - "**/src/templates/**"
        - "**/src/config/contact-form-config.ts"
        - "**/src/testing/utils/theme-test-utilities.ts"
        - "**/src/types/whatsapp-api-config/utils.ts"
        - "**/src/lib/performance-monitoring-config-history.ts"
        - "**/src/lib/performance-monitoring-config-modules.ts"
        # UI-only spread patterns that have been manually reviewed and
        # documented as safe (see .augment/rules/security-implementation.md
        # "Semgrep 规则治理记录" section). These components only spread
        # controlled translation/label objects used for rendering and never
        # handle raw user input.
        - "**/src/app/*/about/page.tsx"
        - "**/src/app/*/products/*/page.tsx"
        - "**/src/components/products/product-card.tsx"
        - "**/src/components/products/product-specs.tsx"
        # Lead pipeline files - spread operators used with Zod-validated data only:
        # - inquiry/route.ts: leadData spread after Zod schema validation (productLeadSchema)
        # - product-inquiry-form.tsx: client-side form with hardcoded field names
        # - lead-schema.ts: Zod schema definitions using baseLeadFields spread (compile-time safe)
        - "**/src/app/api/inquiry/route.ts"
        - "**/src/components/products/product-inquiry-form.tsx"
        - "**/src/lib/lead-pipeline/lead-schema.ts"
        # API routes - spread operators used with internal result objects only:
        # - cache/invalidate: conditional errors array from internal InvalidationResult
        # - verify-turnstile: conditional errorCodes from Cloudflare API response
        - "**/src/app/api/cache/invalidate/route.ts"
        - "**/src/app/api/verify-turnstile/route.ts"
        # Cookie consent - client-side state management with localStorage + hardcoded defaults
        - "**/src/lib/cookie-consent/context.tsx"
        - "**/src/lib/cookie-consent/storage.ts"
        # Lead pipeline internal metrics/logging - data from Zod-validated inputs
        - "**/src/lib/lead-pipeline/metrics.ts"
        - "**/src/lib/lead-pipeline/process-lead.ts"
        # Rate limiting - fetch config object construction (body from internal data)
        - "**/src/lib/security/distributed-rate-limit.ts"
        # UTM tracking - spread operators used with sanitizeParam() validated alphanumeric values
        - "**/src/lib/utm.ts"
        # Logger - spread operator used with internal application logging context, not user input
        - "**/src/lib/logger.ts"
        # Email templates - spread operators used with static CSSProperties style objects
        - "**/src/components/emails/EmailLayout.tsx"
        - "**/src/components/emails/ContactFormEmail.tsx"
        - "**/src/components/emails/ProductInquiryEmail.tsx"
        - "**/src/components/emails/ConfirmationEmail.tsx"
        # Blog newsletter - spread operator used with getAttributionAsObject() sanitized values
        - "**/src/components/blog/blog-newsletter.tsx"
    message: '检测到潜在的对象注入：使用扩展运算符或Object.assign时需验证输入对象的安全性'
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'

  - id: unsafe-property-access-pattern
    pattern-regex: "\\$\\{[^}]*\\}\\s*\\[\\s*[^\\]]*\\s*\\]"
    message: '检测到不安全的属性访问模式：避免在模板字符串中使用动态属性访问'
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'

  - id: object-injection-sink-computed-property
    pattern-either:
      - pattern: |
          { [$KEY]: $VALUE }
      - pattern: |
          { [$KEY]: $VALUE, ...$REST }
    message: '检测到计算属性对象注入：使用动态键创建对象时需要验证键的安全性'
    languages: [typescript, javascript]
    severity: WARNING
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
        # Cookie consent - category key is from ConsentCategory enum type, not user input
        - "**/src/lib/cookie-consent/context.tsx"
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'

  - id: object-injection-sink-for-in-loop
    pattern: |
      for ($KEY in $OBJ) {
        ...
        $TARGET[$KEY] = $VALUE
        ...
      }
    message: '检测到for-in循环中的对象注入：遍历对象属性时需要验证属性键的安全性'
    languages: [typescript, javascript]
    severity: WARNING
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
        # Tech tabs - category comes from Object.keys() of hardcoded categories object, not user input
        - "**/src/components/blocks/tech/tech-tabs-block.tsx"
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'

  - id: object-injection-sink-object-keys
    pattern-either:
      - pattern: |
          Object.keys($OBJ).forEach($KEY => {
            ...
            $TARGET[$KEY] = $VALUE
            ...
          })
      - pattern: |
          Object.entries($OBJ).forEach(([$KEY, $VALUE]) => {
            ...
            $TARGET[$KEY] = $VALUE
            ...
          })
    message: '检测到Object.keys/entries中的对象注入：使用对象键时需要验证键的安全性'
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'

  - id: object-injection-sink-destructuring-assignment
    pattern-either:
      - pattern: |
          const { [$KEY]: $VALUE } = $OBJ
      - pattern: |
          const { [$KEY]: $VALUE, ...$REST } = $OBJ
    message: '检测到解构赋值中的对象注入：使用动态键进行解构时需要验证键的安全性'
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'

  - id: object-injection-sink-reflect-api
    pattern-either:
      - pattern: |
          Reflect.get($OBJ, $KEY)
      - pattern: |
          Reflect.set($OBJ, $KEY, $VALUE)
      - pattern: |
          Reflect.has($OBJ, $KEY)
      - pattern: |
          Reflect.deleteProperty($OBJ, $KEY)
    message: '检测到Reflect API中的对象注入：使用Reflect API时需要验证属性键的安全性'
    languages: [typescript, javascript]
    severity: WARNING
    paths:
      exclude:
        - "**/__tests__/**"
        - "**/*.test.*"
        - "**/*.spec.*"
    metadata:
      category: security
      technology: [nodejs, react, nextjs]
      cwe: 'CWE-94: Improper Control of Generation of Code'
      owasp: 'A03:2021 - Injection'
