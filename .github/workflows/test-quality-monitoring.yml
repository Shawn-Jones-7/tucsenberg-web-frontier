name: Test Quality Monitoring

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/**'
      - 'vitest.config.ts'
      - 'vitest.config.browser.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/**'
      - 'vitest.config.ts'
      - 'vitest.config.browser.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´çš„è´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - browser
          - regression
          - performance
      save_baseline:
        description: 'Save new performance baseline'
        required: false
        default: false
        type: boolean

env:
  NODE_ENV: test
  CI: true

jobs:
  test-quality-check:
    name: Test Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      matrix:
        test-type: [unit, performance, regression]
        include:
          - test-type: unit
            description: "å•å…ƒæµ‹è¯•"
            command: "test --run"
          - test-type: performance
            description: "æ€§èƒ½ç›‘æ§"
            command: "test:performance"
          - test-type: regression
            description: "å›å½’æµ‹è¯•"
            command: "test:regression"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache test reports
        uses: actions/cache@v3
        with:
          path: |
            reports/
            node_modules/.vitest/
            node_modules/.vitest-browser/
          key: test-cache-${{ matrix.test-type }}-${{ github.sha }}
          restore-keys: |
            test-cache-${{ matrix.test-type }}-
            test-cache-

      - name: Load performance baseline
        if: matrix.test-type == 'performance' || matrix.test-type == 'regression'
        uses: actions/cache@v3
        with:
          path: reports/performance-baseline.json
          key: performance-baseline-${{ github.ref_name }}
          restore-keys: |
            performance-baseline-main
            performance-baseline-

      - name: Run ${{ matrix.description }}
        id: test-run
        run: |
          echo "Running ${{ matrix.description }}..."
          pnpm ${{ matrix.command }}
        continue-on-error: true

      - name: Analyze test results
        id: analyze
        run: |
          # åˆ†ææµ‹è¯•ç»“æœå¹¶è®¾ç½®è¾“å‡ºå˜é‡
          if [ -f "reports/performance-report.json" ]; then
            PERFORMANCE_SCORE=$(node -e "
              const report = require('./reports/performance-report.json');
              console.log(report.results[0]?.performanceCheck?.score || 0);
            ")
            echo "performance_score=$PERFORMANCE_SCORE" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "reports/regression-report.json" ]; then
            REGRESSION_SUCCESS=$(node -e "
              const report = require('./reports/regression-report.json');
              console.log(report.summary.overallSuccess ? 'true' : 'false');
            ")
            echo "regression_success=$REGRESSION_SUCCESS" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æŸ¥æµ‹è¯•æ˜¯å¦æˆåŠŸ
          if [ "${{ steps.test-run.outcome }}" == "success" ]; then
            echo "test_success=true" >> $GITHUB_OUTPUT
          else
            echo "test_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-reports-${{ matrix.test-type }}
          path: |
            reports/
            coverage/
          retention-days: 30

      - name: Performance regression alert
        if: matrix.test-type == 'performance' && steps.analyze.outputs.performance_score < 60
        uses: actions/github-script@v6
        with:
          script: |
            const score = ${{ steps.analyze.outputs.performance_score }};
            const title = 'ğŸš¨ æ€§èƒ½å›å½’è­¦å‘Š';
            const body = `
            ## æ€§èƒ½å›å½’æ£€æµ‹
            
            **æ€§èƒ½è¯„åˆ†:** ${score}/100 (ä½äº60åˆ†é˜ˆå€¼)
            **åˆ†æ”¯:** ${{ github.ref_name }}
            **æäº¤:** ${{ github.sha }}
            
            ### å»ºè®®æªæ–½
            1. æ£€æŸ¥æœ€è¿‘çš„ä»£ç å˜æ›´
            2. åˆ†ææ€§èƒ½ç“¶é¢ˆ
            3. ä¼˜åŒ–æµ‹è¯•é…ç½®
            4. è€ƒè™‘è°ƒæ•´æ€§èƒ½é˜ˆå€¼
            
            è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ [Actions è¿è¡Œç»“æœ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            // åˆ›å»ºIssueæˆ–å‘é€é€šçŸ¥
            if (context.eventName === 'push' && context.ref === 'refs/heads/main') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['performance', 'regression', 'urgent']
              });
            }

      - name: Test failure alert
        if: steps.analyze.outputs.test_success == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const testType = '${{ matrix.test-type }}';
            const description = '${{ matrix.description }}';
            
            console.log(`âŒ ${description}å¤±è´¥`);
            
            // å¦‚æœæ˜¯ä¸»åˆ†æ”¯æ¨é€ï¼Œåˆ›å»ºIssue
            if (context.eventName === 'push' && context.ref === 'refs/heads/main') {
              const title = `ğŸš¨ ${description}å¤±è´¥ - ${context.sha.substring(0, 8)}`;
              const body = `
              ## ${description}å¤±è´¥æŠ¥å‘Š
              
              **æµ‹è¯•ç±»å‹:** ${testType}
              **åˆ†æ”¯:** ${{ github.ref_name }}
              **æäº¤:** ${{ github.sha }}
              **æ—¶é—´:** ${new Date().toISOString()}
              
              ### å¤±è´¥è¯¦æƒ…
              è¯·æŸ¥çœ‹ [Actions è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚
              
              ### å»ºè®®æªæ–½
              1. æ£€æŸ¥æµ‹è¯•æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
              2. æœ¬åœ°é‡ç°é—®é¢˜
              3. ä¿®å¤ç›¸å…³ä»£ç 
              4. é‡æ–°è¿è¡Œæµ‹è¯•éªŒè¯
              `;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['test-failure', testType, 'urgent']
              });
            }

  coverage-regression-check:
    name: Coverage Regression Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Load coverage baseline
        uses: actions/cache@v3
        with:
          path: reports/coverage-baseline.json
          key: coverage-baseline-${{ github.ref_name }}
          restore-keys: |
            coverage-baseline-main
            coverage-baseline-

      - name: Run coverage test
        run: pnpm test:coverage

      - name: Analyze coverage regression
        id: coverage-analysis
        run: |
          # ç®€åŒ–çš„è¦†ç›–ç‡åˆ†æ
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE_LINES=$(node -e "
              const summary = require('./coverage/coverage-summary.json');
              console.log(summary.total.lines.pct);
            ")
            echo "coverage_lines=$COVERAGE_LINES" >> $GITHUB_OUTPUT
            
            # æ£€æŸ¥æ˜¯å¦ä½äºé˜ˆå€¼
            if (( $(echo "$COVERAGE_LINES < 50" | bc -l) )); then
              echo "coverage_regression=true" >> $GITHUB_OUTPUT
            else
              echo "coverage_regression=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Coverage regression alert
        if: steps.coverage-analysis.outputs.coverage_regression == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const coverage = ${{ steps.coverage-analysis.outputs.coverage_lines }};
            
            if (context.eventName === 'push' && context.ref === 'refs/heads/main') {
              const title = 'ğŸ“‰ æµ‹è¯•è¦†ç›–ç‡å›å½’è­¦å‘Š';
              const body = `
              ## æµ‹è¯•è¦†ç›–ç‡å›å½’æ£€æµ‹
              
              **å½“å‰è¦†ç›–ç‡:** ${coverage}% (ä½äº50%é˜ˆå€¼)
              **åˆ†æ”¯:** ${{ github.ref_name }}
              **æäº¤:** ${{ github.sha }}
              
              ### å»ºè®®æªæ–½
              1. æ·»åŠ ç¼ºå¤±çš„æµ‹è¯•ç”¨ä¾‹
              2. æé«˜ç°æœ‰æµ‹è¯•è´¨é‡
              3. æ£€æŸ¥ä»£ç å˜æ›´å½±å“
              4. è€ƒè™‘è°ƒæ•´è¦†ç›–ç‡ç›®æ ‡
              
              è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Šã€‚
              `;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['coverage', 'regression', 'quality']
              });
            }

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [test-quality-check, coverage-regression-check]
    if: always()

    steps:
      - name: Download all reports
        uses: actions/download-artifact@v3
        with:
          path: artifacts/

      - name: Generate quality summary
        run: |
          echo "## ğŸ¯ æµ‹è¯•è´¨é‡ç›‘æ§æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥å„é¡¹æµ‹è¯•ç»“æœ
          echo "### ğŸ“‹ æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„jobç»“æœæ¥ç”Ÿæˆè¡¨æ ¼
          echo "| å•å…ƒæµ‹è¯• | ${{ needs.test-quality-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | åŸºç¡€åŠŸèƒ½æµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
          echo "| æ€§èƒ½ç›‘æ§ | ${{ needs.test-quality-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | æ€§èƒ½å›å½’æ£€æµ‹ |" >> $GITHUB_STEP_SUMMARY
          echo "| å›å½’æµ‹è¯• | ${{ needs.test-quality-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | å…³é”®åŠŸèƒ½éªŒè¯ |" >> $GITHUB_STEP_SUMMARY
          echo "| è¦†ç›–ç‡æ£€æŸ¥ | ${{ needs.coverage-regression-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | ä»£ç è¦†ç›–ç‡ç›‘æ§ |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹å„ä¸ªä½œä¸šçš„è¾“å‡ºå’Œä¸Šä¼ çš„æ„ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY

      - name: Set overall status
        run: |
          if [ "${{ needs.test-quality-check.result }}" == "success" ] && [ "${{ needs.coverage-regression-check.result }}" == "success" ]; then
            echo "âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡"
            exit 0
          else
            echo "âŒ è´¨é‡æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
