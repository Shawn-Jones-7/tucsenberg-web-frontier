# Git Hooksç®¡ç†é…ç½®
# è‡ªåŠ¨åŒ–è´¨é‡é—¨ç¦ç³»ç»Ÿ - ç¡®ä¿ä»£ç è´¨é‡å’Œå®‰å…¨æ€§
pre-commit:
  parallel: true
  commands:
    # ä»£ç æ ¼å¼æ£€æŸ¥ (Prettier)
    format-check:
      run: pnpm format:check
      fail_text: 'ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥ - è¯·è¿è¡Œ pnpm format:write ä¿®å¤æ ¼å¼é—®é¢˜'
      stage_fixed: true

    # TypeScriptç±»å‹æ£€æŸ¥
    type-check:
      run: pnpm type-check
      fail_text: 'TypeScriptç±»å‹æ£€æŸ¥å¤±è´¥ - è¯·ä¿®å¤ç±»å‹é”™è¯¯åé‡æ–°æäº¤'
      stage_fixed: true

    # ä»£ç è´¨é‡æ£€æŸ¥ (ESLint) - ä½¿ç”¨å¢é‡æ£€æŸ¥é¿å…å†å²é—®é¢˜é˜»å¡
    quality-check:
      run: pnpm quality:quick:staged
      fail_text: 'ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ - å‘ç°æ–°çš„è´¨é‡é—®é¢˜ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤'
      stage_fixed: true

    # æ¶æ„å®ˆå« - ä»…æ£€æŸ¥å·²æš‚å­˜çš„ JS/TS å˜æ›´ï¼ˆæ’é™¤æµ‹è¯•æ–‡ä»¶ï¼‰
    architecture-guard:
      run: |
        FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep -v '^tests/' | grep -v '__tests__' || true)
        if [ -z "$FILES" ]; then echo "âœ… æ¶æ„å®ˆå«æ£€æŸ¥é€šè¿‡ (æ—  JS/TS å˜æ›´)"; exit 0; fi
        for f in $FILES; do
          if git diff --cached -- "$f" | grep -qE '^\+.*export \* from'; then
            echo "âŒ å‘ç°æ–°å¢export *é‡æ–°å¯¼å‡º: $f"; echo "ğŸš« æ¶æ„é‡æ„æœŸé—´ç¦æ­¢æ–°å¢ export * é‡æ–°å¯¼å‡º";
            echo "è¯·ä½¿ç”¨å‘½åå¯¼å‡ºï¼šexport { specificExport } from './module'"; exit 1; fi
        done
        for f in $FILES; do
          if git diff --cached -- "$f" | grep -qE "^\+.*from ['\"']\./|^\+.*from ['\"']\.\./"; then
            echo "âŒ å‘ç°æ–°å¢ç›¸å¯¹è·¯å¾„å¯¼å…¥: $f"; echo "ğŸš« è¯·ä½¿ç”¨ @/ è·¯å¾„åˆ«åæ›¿ä»£ç›¸å¯¹è·¯å¾„å¯¼å…¥";
            echo "ä¾‹å¦‚ï¼šimport { something } from '@/lib/module'"; exit 1; fi
        done
        echo "âœ… æ¶æ„å®ˆå«æ£€æŸ¥é€šè¿‡"
      fail_text: 'æ¶æ„å®ˆå«æ£€æŸ¥å¤±è´¥ - å‘ç°è¿åæ¶æ„é‡æ„è§„åˆ™çš„ä»£ç å˜æ›´'
      stage_fixed: false

    # åˆ«åä¸€è‡´æ€§æ£€æŸ¥
    config-check:
      run: pnpm config:check
      fail_text: 'åˆ«åä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ - è¯·ä¿®å¤ tsconfig/next.config/ESLint é…ç½®ä¸€è‡´æ€§'
      stage_fixed: false

    # å¤šè¯­è¨€åŒæ­¥æ£€æŸ¥
    i18n-sync:
      run: |
        if git diff --cached --name-only | grep -E '^(messages/|content/|i18n\.(json|ts)$|src/.+i18n|translation\.config\.js)' >/dev/null; then
          pnpm i18n:full
        else
          echo "è·³è¿‡ i18n åŒæ­¥æ£€æŸ¥ï¼ˆæ— ç›¸å…³å˜æ›´ï¼‰"; exit 0;
        fi
      fail_text: 'å¤šè¯­è¨€åŒæ­¥æ£€æŸ¥å¤±è´¥ - è¯·åŒæ­¥ messages ä¸å†…å®¹æ–‡ä»¶çš„ä¸­è‹±ç‰ˆæœ¬'
      stage_fixed: false

commit-msg:
  commands:
    commitlint:
      run: pnpm commitlint --edit {1}
      fail_text:
        'æäº¤ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒ - è¯·ä½¿ç”¨çº¦å®šå¼æäº¤æ ¼å¼ï¼štype(scope): description'

pre-push:
  parallel: false  # æ”¹ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œç¡®ä¿ build-check å…ˆå®Œæˆç”Ÿæˆ .next/ ç›®å½•
  commands:
    # æ„å»ºæˆåŠŸéªŒè¯
    build-check:
      run: pnpm build:check
      fail_text: 'æ„å»ºéªŒè¯å¤±è´¥ - è¯·ä¿®å¤æ„å»ºé”™è¯¯åå†æ¨é€'

    # é›†æˆæµ‹è¯•ï¼ˆè¦†ç›–ç‡æ¨¡å¼ï¼‰
    integration-test:
      run: pnpm test:coverage
      fail_text: 'é›†æˆæµ‹è¯•å¤±è´¥ - è¯·ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†æ¨é€'

    # ç¿»è¯‘éªŒè¯
    translation-check:
      run: pnpm validate:translations
      fail_text: 'ç¿»è¯‘éªŒè¯å¤±è´¥ - è¯·ç¡®ä¿æ‰€æœ‰ç¿»è¯‘æ–‡ä»¶åŒæ­¥'

    # è´¨é‡é—¨ç¦
    quality-gate:
      run: pnpm quality:gate
      fail_text: 'è´¨é‡é—¨ç¦å¤±è´¥ - è¯·ä¿®å¤è´¨é‡é—®é¢˜åå†æ¨é€'

    # æ¶æ„æ£€æŸ¥
    arch-check:
      run: pnpm arch:check && pnpm circular:check
      fail_text: 'æ¶æ„æ£€æŸ¥å¤±è´¥ - å‘ç°å¾ªç¯ä¾èµ–æˆ–æ¶æ„è¿è§„'

    # æ€§èƒ½æµ‹è¯• (ä»… CI ç¯å¢ƒè¿è¡Œ,é¿å…æœ¬åœ° headless Chrome å¡ä½)
    performance-test:
      run: |
        if [ -n "$CI" ]; then
          pnpm perf:check
        else
          echo "â­ï¸  è·³è¿‡æ€§èƒ½æµ‹è¯• (ä»… CI ç¯å¢ƒè¿è¡Œ,æœ¬åœ°å·²é€šè¿‡ build-check éªŒè¯)"
        fi
      fail_text: 'æ€§èƒ½æµ‹è¯•å¤±è´¥ - åŒ…å¤§å°æˆ–æ€§èƒ½æŒ‡æ ‡è¶…å‡ºé™åˆ¶'

    # å®‰å…¨æ£€æŸ¥
    security-check:
      run: pnpm security:audit
      fail_text: 'å®‰å…¨æ£€æŸ¥å¤±è´¥ - å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·ä¿®å¤åæ¨é€'
