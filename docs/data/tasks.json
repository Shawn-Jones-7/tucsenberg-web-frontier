{
  "tasks": [
    {
      "id": "9f6af756-a5a9-4ce7-8499-c991dc40e0df",
      "name": "升级 Vitest 核心依赖到 v4 并同步套件",
      "description": "将 vitest 升级到 ^4.0.8，并同步升级 @vitest/ui 与 @vitest/coverage-v8 到 ^4；新增 @vitest/browser-playwright 以支持 Browser Mode v4 provider；如存在 @vitest/browser，移除之。保持 package.json scripts 不变。",
      "status": "pending",
      "dependencies": [],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "package.json",
          "type": "TO_MODIFY",
          "description": "升级 vitest 相关依赖版本",
          "lineStart": 120,
          "lineEnd": 162
        },
        {
          "path": "evidence/vitest-upgrade-feasibility-2025-11-13.md",
          "type": "OTHER",
          "description": "变更与验证记录"
        }
      ],
      "implementationGuide": "pseudocode:\n- edit package.json.devDependencies:\n  - vitest = ^4.0.8\n  - @vitest/ui = ^4.0.8\n  - @vitest/coverage-v8 = ^4.0.8\n  - add @vitest/browser-playwright = ^4.0.8\n  - remove @vitest/browser if present\n- pnpm install (生成 lockfile)\n- 不修改 scripts\n- 记录变更到 evidence/",
      "verificationCriteria": "- pnpm i 成功，未修改 scripts；\n- pnpm test 可运行（初步），无致命报错；\n- 生成依赖变更记录（evidence 更新）。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    },
    {
      "id": "6e505e63-6993-413b-bcf3-0b0c20259c63",
      "name": "迁移 vitest.config.mts（deps.optimizer.web→client 与覆盖率校验）",
      "description": "将 test.deps.optimizer.web 更名为 client；校验 coverage 配置兼容 v4（保留 include/exclude；确认未使用已移除选项）。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "9f6af756-a5a9-4ce7-8499-c991dc40e0df"
        }
      ],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "vitest.config.mts",
          "type": "TO_MODIFY",
          "description": "deps.optimizer.web → client；覆盖率配置核对",
          "lineStart": 250,
          "lineEnd": 266
        }
      ],
      "implementationGuide": "pseudocode:\n- open vitest.config.mts\n- replace: test.deps.optimizer.web -> test.deps.optimizer.client\n- ensure: test.coverage.include 已定义（项目已定义 src/**/*，保留）\n- ensure: 未使用 coverage.all / coverage.extensions / ignoreEmptyLines\n- 保存并运行 pnpm test 校验",
      "verificationCriteria": "- grep 不再出现 deps.optimizer.web；\n- pnpm test 正常；\n- 覆盖率配置与报告生成正常。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    },
    {
      "id": "63bde723-ed2a-4ea0-88b6-0816a4e17701",
      "name": "迁移 vitest.config.browser.ts 至 v4 Provider API",
      "description": "为 Browser Mode 引入 @vitest/browser-playwright，并将 provider 从字符串写法改为函数写法；移除三斜线引用；避免与 environment: 'happy-dom' 混用。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "9f6af756-a5a9-4ce7-8499-c991dc40e0df"
        }
      ],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "vitest.config.browser.ts",
          "type": "TO_MODIFY",
          "description": "provider 改为 playwright()，移除三斜线引用",
          "lineStart": 1,
          "lineEnd": 80
        },
        {
          "path": "vitest.config.browser.ts",
          "type": "TO_MODIFY",
          "description": "browser.provider 与 instances 段落",
          "lineStart": 49,
          "lineEnd": 76
        }
      ],
      "implementationGuide": "pseudocode:\n- import { playwright } from '@vitest/browser-playwright'\n- test.browser.provider: playwright()\n- 删除 /// <reference types='@vitest/browser/providers/playwright' />\n- 如启用 browser 模式，移除 environment: 'happy-dom'（改由 browser runner 提供环境）\n- 运行浏览器模式测试验证",
      "verificationCriteria": "- 配置中使用 provider: playwright()；\n- 不再有三斜线引用；\n- 浏览器测试可启动（如配置并有用例）。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    },
    {
      "id": "0676ee66-373d-4f3a-b716-a3d42cbe402a",
      "name": "Mock 行为差异审查与用例修复",
      "description": "针对 v4 中 vi.restoreAllMocks 不再重置 automock、构造函数 spy 支持与名称变化等，搜索并修复依赖旧语义的测试用例。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "9f6af756-a5a9-4ce7-8499-c991dc40e0df"
        }
      ],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "src",
          "type": "OTHER",
          "description": "测试源码目录（多处用例修复）"
        },
        {
          "path": "tests",
          "type": "OTHER",
          "description": "测试场景目录（多处用例修复）"
        },
        {
          "path": "docs/known-issues/vitest-4-upgrade.md",
          "type": "TO_MODIFY",
          "description": "补充已知问题与修复策略"
        }
      ],
      "implementationGuide": "pseudocode:\n- 搜索: vi.restoreAllMocks / vi.resetAllMocks / vi.clearAllMocks / vi.spyOn(... new) / mockImplementation(()=>)\n- 策略：\n  - 若依赖 restoreAllMocks 还原 automock，改为 resetAllMocks 或显式 mockRestore/重设返回\n  - 构造函数 spy，使用 function/class 实现替代箭头函数\n- 跑全量测试并迭代修复",
      "verificationCriteria": "- 全量测试通过；\n- 相关用例不再因 restoreAllMocks 语义变化失败；\n- 记录修复点与原因。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    },
    {
      "id": "1c2f948d-3cf9-401e-ac96-35c698c2b016",
      "name": "覆盖率基线重测与阈值校准",
      "description": "由于 V8 覆盖率 AST 重映射更精确，重测覆盖率；仅在必要时对局部阈值微调以维持 Phase1≥65%。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "6e505e63-6993-413b-bcf3-0b0c20259c63"
        },
        {
          "taskId": "0676ee66-373d-4f3a-b716-a3d42cbe402a"
        }
      ],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "vitest.config.mts",
          "type": "TO_MODIFY",
          "description": "阈值可能需要微调（仅必要时）",
          "lineStart": 124,
          "lineEnd": 217
        },
        {
          "path": "coverage/coverage-final.json",
          "type": "OTHER",
          "description": "覆盖率输出（运行后生成）"
        }
      ],
      "implementationGuide": "pseudocode:\n- 执行 pnpm test:coverage\n- 比对 ./coverage 与 json-summary\n- 分析下降原因：死代码、类型护栏、分支不可达\n- 必要时微调 vitest.config.mts 中特定文件 thresholds（不放宽全局目标）\n- 更新 evidence 记录",
      "verificationCriteria": "- 覆盖率报告生成成功；\n- 全局覆盖率≥65%；\n- 如调阈值，有充分证据并在 evidence 说明。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    },
    {
      "id": "d6bbfd47-c8a8-4aad-b905-697137779b23",
      "name": "Browser Mode 校验与 Playwright 集成验证",
      "description": "在本地与 CI 等价环境中验证浏览器模式可用性，确保 provider 配置、实例、视口等设置生效；必要时确认是否需要安装 playwright 包（如仅有 @playwright/test）。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "63bde723-ed2a-4ea0-88b6-0816a4e17701"
        }
      ],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "vitest.config.browser.ts",
          "type": "REFERENCE",
          "description": "Browser Mode 配置"
        },
        {
          "path": "package.json",
          "type": "REFERENCE",
          "description": "@playwright/test 与相关脚本"
        }
      ],
      "implementationGuide": "pseudocode:\n- 本地运行：pnpm vitest --config vitest.config.browser.ts 或 npm script 等价命令\n- 如提示缺少 playwright，安装 devDep: playwright 并执行 playwright install\n- 验证截图/并行/viewport 配置按预期工作",
      "verificationCriteria": "- 浏览器模式测试可运行；\n- 不出现 provider 相关报错；\n- 关键用例在浏览器模式下通过。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    },
    {
      "id": "08f24573-a58d-4a00-a132-3c6460857726",
      "name": "质量门禁回归：类型/ESLint/体系化检查",
      "description": "在不修改 CI 配置前提下，本地执行与 CI 等价的质量门禁：类型检查、ESLint、质量门禁脚本、尺寸预算检查等，确保零报错。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "1c2f948d-3cf9-401e-ac96-35c698c2b016"
        },
        {
          "taskId": "d6bbfd47-c8a8-4aad-b905-697137779b23"
        }
      ],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "package.json",
          "type": "REFERENCE",
          "description": "质量门禁相关脚本定义",
          "lineStart": 10,
          "lineEnd": 60
        }
      ],
      "implementationGuide": "pseudocode:\n- pnpm type-check:tests\n- pnpm lint:check\n- pnpm ci:quality\n- pnpm size:check / build:check（如需要）\n- 记录结果与问题修复点",
      "verificationCriteria": "- 所有命令零报错；\n- 构建与静态检查通过；\n- 质量门禁报告符合门槛。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    },
    {
      "id": "ba7687fd-9f7e-4cb0-839c-a638df15c422",
      "name": "文档与回滚方案更新",
      "description": "更新 docs/known-issues/vitest-4-upgrade.md 与 evidence/ 记录，补充升级步骤、兼容性观察、阈值变化原因与回滚命令；声明“无迁移，直接替换”。",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "08f24573-a58d-4a00-a132-3c6460857726"
        }
      ],
      "createdAt": "2025-11-13T03:48:58.796Z",
      "updatedAt": "2025-11-13T03:48:58.796Z",
      "relatedFiles": [
        {
          "path": "docs/known-issues/vitest-4-upgrade.md",
          "type": "TO_MODIFY",
          "description": "补充 v4 升级实操与常见问题"
        },
        {
          "path": "evidence/vitest-upgrade-feasibility-2025-11-13.md",
          "type": "TO_MODIFY",
          "description": "补充验证过程与最终结论"
        }
      ],
      "implementationGuide": "pseudocode:\n- 更新已知问题文档：mock 差异、coverage 变化、provider 迁移\n- 在 evidence/ 增补执行日志与比对结论\n- 记录回滚命令：pnpm up -D vitest@3.2.4 等\n- 产出最终交付说明",
      "verificationCriteria": "- 文档更新完整（升级、差异、验证、回滚）；\n- evidence 中包含最终验证与时间戳；\n- 明确声明“无迁移，直接替换”。",
      "analysisResult": "Vitest 升级（v3.2.4→v4.0.8）在本项目的技术可行：Node(>=20)与Vite(7)满足要求；需同步升级 @vitest/ui 与 @vitest/coverage-v8，并迁移 Browser Mode 至 @vitest/browser-playwright 的 provider API；配置项 deps.optimizer.web→client；覆盖率 AST 重映射可能引发阈值波动；mock 语义（restoreAllMocks 等）变化需审查；不修改 CI/CD 配置。整体风险中等，可通过分阶段验证与回滚方案降低风险。"
    }
  ]
}